<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stack Overflow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@500;800&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; overflow: hidden; background: #09090b; font-family: 'JetBrains Mono', monospace; user-select: none; -webkit-tap-highlight-color: transparent; }
        canvas { display: block; width: 100%; height: 100%; }
        
        /* UI OVERLAY */
        #ui {
            position: absolute; inset: 0; pointer-events: none;
            display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10;
        }
        
        /* SCORE */
        #score-board {
            position: absolute; top: 15%; 
            font-size: 80px; font-weight: 800; color: rgba(255,255,255,0.2);
            transition: 0.2s; text-shadow: 0 0 30px rgba(255,255,255,0.1);
        }
        
        /* MENU SCREEN */
        #menu {
            pointer-events: auto; text-align: center;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(20px);
            padding: 40px; border-radius: 24px; border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
            transform: scale(0.9); opacity: 0; transition: 0.3s; pointer-events: none;
        }
        #menu.visible { transform: scale(1); opacity: 1; pointer-events: auto; }

        .btn-start {
            margin-top: 20px; padding: 16px 40px; font-size: 16px; font-weight: bold;
            background: #fff; color: #000; border-radius: 12px; cursor: pointer; border: none;
            transition: 0.2s; box-shadow: 0 0 20px rgba(255,255,255,0.2);
        }
        .btn-start:hover { transform: scale(1.05); box-shadow: 0 0 40px rgba(255,255,255,0.5); }
        .btn-start:active { transform: scale(0.95); }

    </style>
</head>
<body>

    <canvas id="game"></canvas>

    <div id="ui">
        <div id="score-board">0</div>
        
        <div id="menu" class="visible">
            <div class="mb-4">
                <i data-lucide="layers" class="w-12 h-12 text-blue-500 mx-auto mb-2"></i>
                <h1 class="text-3xl font-bold text-white mb-1">STACK OVERFLOW</h1>
                <p class="text-xs text-gray-400">Precision Architecture</p>
            </div>
            <div id="final-score" class="text-sm text-gray-300 mb-4 hidden">Score: 0</div>
            <button id="start-btn" class="btn-start" onclick="startGame()">START BUILD</button>
        </div>
    </div>

    <script>
        lucide.createIcons();

        // --- ENGINE CONFIG ---
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        const scoreEl = document.getElementById('score-board');
        const menuEl = document.getElementById('menu');
        
        // Colors
        const COLORS = {
            bg: '#09090b',
            base: '#3b82f6'
        };

        // Game State
        let state = {
            playing: false,
            score: 0,
            blocks: [],
            current: null,
            speed: 3,
            direction: 1, // 1 = right, -1 = left
            cameraY: 0,
            hue: 200
        };

        const INITIAL_WIDTH = 200;
        const HEIGHT = 30;
        let START_Y = 600;

        // --- RESIZE ---
        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            START_Y = canvas.height - 150; 
            if(!state.playing) renderTitleScreen();
        }
        window.addEventListener('resize', resize);

        // --- GAME LOOP ---
        function startGame() {
            state.playing = true;
            state.score = 0;
            state.blocks = [];
            state.speed = 4;
            state.cameraY = 0;
            state.hue = 200;
            
            scoreEl.innerText = "0";
            scoreEl.style.color = "rgba(255,255,255,0.2)";
            menuEl.classList.remove('visible');

            // Base Block
            addBlock(canvas.width/2 - INITIAL_WIDTH/2, START_Y, INITIAL_WIDTH);
            
            spawnNextBlock();
            loop();
        }

        function spawnNextBlock() {
            const prevBlock = state.blocks[state.blocks.length - 1];
            
            // --- BUG FIX & LOGIC UPGRADE ---
            // 1. Alternate sides based on score (Even = Left->Right, Odd = Right->Left)
            // 2. Force reset direction so it never flies off-screen
            
            if (state.score % 2 === 0) {
                state.direction = 1; // Move Right
                var startX = -prevBlock.w; // Start from Left Edge
            } else {
                state.direction = -1; // Move Left
                var startX = canvas.width; // Start from Right Edge
            }
            
            state.current = {
                x: startX,
                y: prevBlock.y - HEIGHT,
                w: prevBlock.w,
                h: HEIGHT,
                color: `hsl(${state.hue}, 80%, 60%)`
            };
            
            state.hue += 5; 
            state.speed += 0.1;
        }

        function loop() {
            if (!state.playing) return;
            update();
            draw();
            requestAnimationFrame(loop);
        }

        function update() {
            if (!state.current) return;

            // Move Block
            state.current.x += state.speed * state.direction;

            // Bounce off walls (Just in case they miss)
            if (state.current.x > canvas.width) {
               state.direction = -1;
            } else if (state.current.x + state.current.w < 0) {
               state.direction = 1; 
            }
        }

        // --- INPUT ---
        function placeBlock(e) {
            // Ignore clicks on menu
            if(e && e.target && (e.target.closest('#menu') || e.target.closest('.btn-start'))) return;
            if(e && e.type === 'touchstart') e.preventDefault();

            if (!state.playing || !state.current) return;

            const curr = state.current;
            const prev = state.blocks[state.blocks.length - 1];

            const dist = curr.x - prev.x;
            const overlap = prev.w - Math.abs(dist);

            if (overlap > 0) {
                // Cut the block
                curr.w = overlap;
                curr.x = dist > 0 ? curr.x : prev.x;

                state.blocks.push(curr);
                state.score++;
                scoreEl.innerText = state.score;
                
                // Flash
                scoreEl.style.color = "white";
                setTimeout(() => scoreEl.style.color = "rgba(255,255,255,0.2)", 100);

                // Move Camera
                const targetY = canvas.height - 300;
                if (curr.y < targetY) {
                    state.cameraY += HEIGHT;
                }

                spawnNextBlock();

            } else {
                gameOver();
            }
        }

        window.addEventListener('mousedown', placeBlock);
        window.addEventListener('touchstart', placeBlock, {passive: false});
        window.addEventListener('keydown', (e) => { if(e.code === 'Space') placeBlock() });

        function gameOver() {
            state.playing = false;
            menuEl.classList.add('visible');
            document.getElementById('final-score').innerText = `Final Height: ${state.score} Blocks`;
            document.getElementById('final-score').classList.remove('hidden');
        }

        function addBlock(x, y, w) {
            state.blocks.push({
                x, y, w, h: HEIGHT,
                color: COLORS.base
            });
        }

        // --- RENDER ---
        function draw() {
            ctx.fillStyle = COLORS.bg;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.save();
            ctx.translate(0, state.cameraY);

            // Draw Stack
            state.blocks.forEach(b => {
                ctx.fillStyle = b.color;
                ctx.shadowBlur = 15; ctx.shadowColor = b.color;
                ctx.fillRect(b.x, b.y, b.w, b.h);
                // 3D Highlight
                ctx.fillStyle = 'rgba(255,255,255,0.3)';
                ctx.fillRect(b.x, b.y, b.w, 4);
                ctx.shadowBlur = 0;
            });

            // Draw Current
            if (state.current) {
                const c = state.current;
                ctx.fillStyle = c.color;
                ctx.shadowBlur = 20; ctx.shadowColor = c.color;
                ctx.fillRect(c.x, c.y, c.w, c.h);
                ctx.fillStyle = 'rgba(255,255,255,0.5)';
                ctx.fillRect(c.x, c.y, c.w, 4);
            }

            ctx.restore();
        }

        function renderTitleScreen() {
            ctx.fillStyle = COLORS.bg;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        resize();

    </script>
</body>
</html>
